<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TechBoston CSP Console ‚Äî Mini Interpreter</title>
  <style>
    :root { --bg:#0b0f14; --panel:#121923; --accent:#60a5fa; --muted:#94a3b8; --good:#22c55e; --bad:#ef4444; }
    * { box-sizing: border-box; }
    body { margin:0; background:var(--bg); color:#e5e7eb; font:16px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Inter, sans-serif; }
    header { padding:18px 20px; border-bottom:1px solid #1f2937; background:linear-gradient(180deg, #0d1420, #0b0f14); position:sticky; top:0; z-index:2; }
    h1 { margin:0 0 6px; font-size:20px; letter-spacing:.2px; }
    .sub { color:var(--muted); font-size:13px }
    main { display:grid; grid-template-columns:1.1fr .9fr; gap:16px; padding:16px; }
    .card { background:var(--panel); border:1px solid #1f2937; border-radius:14px; overflow:hidden; box-shadow:0 10px 30px rgba(0,0,0,.25); }
    .card h2 { font-size:14px; margin:0; padding:10px 12px; color:#cbd5e1; border-bottom:1px solid #1f2937; background:#101623; }
    .toolbar { display:flex; gap:8px; padding:10px; border-bottom:1px solid #1f2937; align-items:center; flex-wrap:wrap; }
    button, select { background:#182232; color:#e5e7eb; border:1px solid #1f2937; padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:600; }
    button:hover { border-color:#334155 }
    button.primary { background:var(--accent); color:#07121e; border-color:#3b82f6; }
    button.danger { background:#1a1620; color:#fecaca; border-color:#7f1d1d }
    textarea { width:100%; height:430px; resize:vertical; background:#0c1320; color:#e5e7eb; border:0; outline:none; padding:12px 14px; font:14px/1.45 ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; caret-color:var(--accent); }
    .console { height:480px; overflow:auto; padding:12px; font:14px/1.5 ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; background:#05080f; }
    .line { white-space:pre-wrap; }
    .log  { color:#d1fae5 }
    .err  { color:#fecaca }
    .sys  { color:#93c5fd }
    .status { padding:8px 12px; font-size:12px; color:var(--muted); border-top:1px solid #1f2937; background:#0e1522 }
    .kbd { padding:1px 6px; border:1px solid #334155; border-bottom-width:3px; border-radius:6px; background:#0b1220; font:12px ui-monospace, monospace; color:#cbd5e1 }
    .prompt-wrap { display:none; gap:8px; padding:10px; border-top:1px solid #1f2937; background:#0d1420; }
    .prompt-wrap input { flex:1; background:#0b1220; color:#e5e7eb; border:1px solid #1f2937; border-radius:10px; padding:10px 12px; }
    .prompt-wrap.show { display:flex }
    footer { color:var(--muted); text-align:center; font-size:12px; padding:10px; }
    .pill { background:#0b1220; border:1px solid #1f2937; border-radius:999px; padding:3px 8px; font-size:12px; color:#cbd5e1 }
  </style>
</head>
<body>
  <header>
    <h1>TechBoston CSP Console <span class="pill">mini interpreter</span></h1>
    <div class="sub">Supports: <b>SET</b>, <b>DISPLAY</b>, <b>INPUT</b>, <b>IF / ELSE / END IF</b>, <b>REPEAT n TIMES / END REPEAT</b>, <b>REPEAT UNTIL cond / END REPEAT</b>. Expressions with + - * /, comparisons (=, ‚â†, <, ‚â§, >, ‚â•), and strings in quotes.</div>
  </header>

  <main>
    <section class="card">
      <h2>Program</h2>
      <div class="toolbar">
        <button class="primary" id="runBtn">‚ñ∂ Run</button>
        <button id="stopBtn" class="danger">‚ñ† Stop</button>
        <select id="samples"></select>
        <span style="margin-left:auto"></span>
        <span class="sub">Tip: press <span class="kbd">Ctrl</span>+<span class="kbd">Enter</span> to run</span>
      </div>
      <textarea id="editor"></textarea>
    </section>

    <section class="card">
      <h2>Console</h2>
      <div class="console" id="console"></div>
      <div class="prompt-wrap" id="promptWrap">
        <input id="promptInput" placeholder="Enter input‚Ä¶" />
        <button id="promptOk">OK</button>
        <button id="promptCancel">Cancel</button>
      </div>
      <div class="status" id="status">Idle</div>
    </section>
  </main>
  <footer>
    MIT License. Single-file, GitHub Pages ready. üéí
  </footer>

<script>
// --- Mini Interpreter -----------------------------------------------
// Grammar (line-oriented):
//  - SET name ‚Üê expr         (‚Üê or <-)
//  - DISPLAY(expr)
//  - name ‚Üê expr             (assignment without SET also allowed)
//  - IF condition            -> END IF (optional ELSE)
//  - REPEAT n TIMES          -> END REPEAT
//  - REPEAT UNTIL condition  -> END REPEAT (post-check)
//  - INPUT() usable inside expressions, or INPUT("prompt")
//  - Comments start with # or //
//  - Strings in "double quotes"

(function(){
  const $ = sel => document.querySelector(sel);
  const logEl = $('#console');
  const statusEl = $('#status');
  const promptWrap = $('#promptWrap');
  const promptInput = $('#promptInput');
  const promptOk = $('#promptOk');
  const promptCancel = $('#promptCancel');

  let halted = false;
  let inputResolve = null, inputReject = null;

  function setStatus(txt){ statusEl.textContent = txt; }
  function clearConsole(){ logEl.innerHTML = ''; }
  function out(text, cls='log'){
    const div = document.createElement('div');
    div.className = 'line ' + cls; div.textContent = String(text);
    logEl.appendChild(div); logEl.scrollTop = logEl.scrollHeight;
  }
  function sys(text){ out(text, 'sys'); }
  function err(text){ out(text, 'err'); }

  function showPrompt(message){
    promptWrap.classList.add('show');
    promptInput.value = '';
    if (message) promptInput.placeholder = message;
    promptInput.focus();
    return new Promise((resolve, reject)=>{
      inputResolve = resolve; inputReject = reject;
    });
  }
  function hidePrompt(){
    promptWrap.classList.remove('show');
  }

  promptOk.addEventListener('click', ()=>{ if (inputResolve){ inputResolve(promptInput.value); hidePrompt(); }});
  promptCancel.addEventListener('click', ()=>{ if (inputReject){ inputReject(new Error('Input canceled')); hidePrompt(); }});
  promptInput.addEventListener('keydown', (e)=>{
    if (e.key === 'Enter'){ e.preventDefault(); promptOk.click(); }
    if (e.key === 'Escape'){ e.preventDefault(); promptCancel.click(); }
  });

  // Simple tokenizer: split into trimmed lines, remove comments
  function preprocess(src){
    const lines = src.split(/\r?\n/).map((raw, idx)=>{
      let s = raw.replace(/\t/g,'    ');
      s = s.replace(/#.*$/, '').replace(/\/\/.*$/, '');
      return { idx, raw, s: s.trim() };
    });
    return lines;
  }

  // Build a control-flow map for IF/ELSE/END IF and REPEAT blocks
  function buildBlocks(lines){
    const stack = [];
    const blocks = {};
    for (let i=0;i<lines.length;i++){
      const t = lines[i].s;
      if (!t) continue;
      if (/^IF\b/i.test(t)) { stack.push({type:'IF', i}); }
      else if (/^ELSE\b/i.test(t)) {
        const top = stack[stack.length-1];
        if (!top || top.type!=='IF') throw new Error(`ELSE without IF at line ${i+1}`);
        blocks[top.i] = blocks[top.i] || {}; blocks[top.i].else = i;
      }
      else if (/^END\s*IF\b/i.test(t)) {
        const top = stack.pop();
        if (!top || top.type!=='IF') throw new Error(`END IF without IF at line ${i+1}`);
        blocks[top.i] = blocks[top.i] || {}; blocks[top.i].end = i;
      }
      else if (/^REPEAT\b/i.test(t)) {
        if (/^REPEAT\s+\d+\s+TIMES\b/i.test(t)) {
          stack.push({type:'REPEAT_TIMES', i});
        } else if (/^REPEAT\s+UNTIL\b/i.test(t)) {
          stack.push({type:'REPEAT_UNTIL', i});
        }
      }
      else if (/^END\s*REPEAT\b/i.test(t)) {
        const top = stack.pop();
        if (!top || (top.type!=='REPEAT_TIMES' && top.type!=='REPEAT_UNTIL'))
          throw new Error(`END REPEAT without REPEAT at line ${i+1}`);
        blocks[top.i] = blocks[top.i] || {}; blocks[top.i].end = i;
      }
    }
    if (stack.length) throw new Error('Unclosed block starting at line ' + (stack[stack.length-1].i+1));
    return blocks;
  }

  // Safe-ish evaluator: allow variables and basic Math; block keywords and dangerous tokens
  function makeEvaluator(env){
    const allowed = /^[\w\s+\-*/%().,<>!=\"'\[\]‚â§‚â•‚â†]+$/u; // crude gate
    function sanitize(s){
      if (!allowed.test(s)) throw new Error('Expression contains unsupported characters');
      // normalize APCSP operators to JS
      return s
        .replace(/‚â§/g,'<=')
        .replace(/‚â•/g,'>=')
        .replace(/‚â†/g,'!=')
        .replace(/\bAND\b/gi,'&&')
        .replace(/\bOR\b/gi,'||')
        .replace(/\bNOT\b/gi,'!');
    }
    return async function evalExpr(expr){
      const e = sanitize(expr);
      // Provide INPUT within expressions
      const INPUT = async function(promptMsg){
        sys('INPUT' + (promptMsg?` ‚Äî ${promptMsg}`:''));
        return await showPrompt(promptMsg||'Input');
      };
      // with(env) gives variable lookup from env
      const fn = new Function('env','Math','INPUT', `with(env){ return ( ${e} ); }`);
      return await fn(env, Math, INPUT);
    };
  }

  async function run(src){
    halted = false; clearConsole(); setStatus('Parsing‚Ä¶');
    const lines = preprocess(src);
    let blocks; try { blocks = buildBlocks(lines); } catch(e){ err(e.message); return; }
    const env = Object.create(null);
    const evalExpr = makeEvaluator(env);
    let i = 0; const maxSteps = 20000; let steps = 0;

    function goto(n){ i = n; }

    setStatus('Running‚Ä¶');
    while (i < lines.length){
      if (halted) { setStatus('Stopped'); return; }
      if (++steps > maxSteps) { err('Program aborted: too many steps (infinite loop?)'); break; }
      const L = lines[i];
      const t = L.s; i++;
      if (!t) continue;

      try{
        // DISPLAY(x)
        if (/^DISPLAY\s*\(/i.test(t)){
          const m = t.match(/^DISPLAY\s*\((.*)\)\s*$/i);
          if (!m) throw new Error(`DISPLAY syntax error at line ${L.idx+1}`);
          const val = await evalExpr(m[1]);
          out(val);
        }
        // SET x ‚Üê expr  OR  x ‚Üê expr
        else if (/^(SET\s+)?[A-Za-z_]\w*\s*(‚Üê|<-)\s*/.test(t)){
          const m = t.match(/^(?:SET\s+)?([A-Za-z_]\w*)\s*(?:‚Üê|<-)\s*(.*)$/i);
          const name = m[1]; const expr = m[2];
          env[name] = await evalExpr(expr);
        }
        // IF cond
        else if (/^IF\b/i.test(t)){
          const cond = t.replace(/^IF\b/i,'').replace(/^\s*\(?/,'').replace(/\)?\s*$/,'').replace(/\s*THEN\s*$/i,'').trim();
          const ok = await evalExpr(cond);
          const meta = blocks[L.idx];
          if (ok){ /* run through */ }
          else {
            if (meta && typeof meta.else==='number') { goto(meta.else+1); }
            else if (meta && typeof meta.end==='number') { goto(meta.end+1); }
            else throw new Error('IF without END IF at line ' + (L.idx+1));
          }
        }
        else if (/^ELSE\b/i.test(t)){
          const meta = blocks[findMatchingIf(lines, L.idx)];
          if (!meta || typeof meta.end!=='number') throw new Error('ELSE without END IF at line ' + (L.idx+1));
          goto(meta.end+1);
        }
        else if (/^END\s*IF\b/i.test(t)){
          // no-op
        }
        // REPEAT n TIMES
        else if (/^REPEAT\s+\d+\s+TIMES\b/i.test(t)){
          const m = t.match(/^REPEAT\s+(\d+)\s+TIMES\b/i);
          const count = parseInt(m[1],10);
          const meta = blocks[L.idx];
          if (!meta || typeof meta.end!== 'number') throw new Error('REPEAT TIMES without END REPEAT');
          // create hidden counters
          const key = `_rep_${L.idx}`; const end = meta.end;
          if (env[key] == null) env[key] = {n:count, c:0};
          if (env[key].c >= env[key].n){ delete env[key]; goto(end+1); }
          else { env[key].c++; }
        }
        // REPEAT UNTIL condition  (post-check loop)
        else if (/^REPEAT\s+UNTIL\b/i.test(t)){
          const cond = t.replace(/^REPEAT\s+UNTIL\b/i,'').trim();
          const meta = blocks[L.idx];
          if (!meta || typeof meta.end!== 'number') throw new Error('REPEAT UNTIL without END REPEAT');
          // store the condition to check at END REPEAT
          env[`_until_${L.idx}`] = cond;
        }
        else if (/^END\s*REPEAT\b/i.test(t)){
          // find matching REPEAT ... by walking back
          const start = findMatchingRepeat(lines, L.idx);
          const startLine = lines[start];
          if (/^REPEAT\s+UNTIL\b/i.test(startLine.s)){
            const cond = env[`_until_${start}`];
            const ok = await evalExpr(cond);
            if (ok) { delete env[`_until_${start}`]; /* fall through */ }
            else { goto(start+1); }
          } else {
            // for TIMES, just fall through; counter already advanced
          }
        }
        else {
          // Bare expression? Allow function-style calls like INPUT("name")
          if (/^INPUT\s*\(/i.test(t)){
            // Discarded value unless assigned; still executes for side-effect prompt
            await makeEvaluator(env)(t);
          } else if (t) {
            throw new Error(`Unknown statement at line ${L.idx+1}: ${t}`);
          }
        }
      } catch(e){
        err(`Line ${L.idx+1}: ${e.message}`);
        setStatus('Crashed');
        return;
      }
      await tick();
    }
    setStatus('Finished');
  }

  function findMatchingIf(lines, elseIndex){
    for (let k=elseIndex-1; k>=0; k--){ if (/^IF\b/i.test(lines[k].s)) return k; }
    return -1;
  }
  function findMatchingRepeat(lines, endIdx){
    for (let k=endIdx-1; k>=0; k--){ if (/^REPEAT\b/i.test(lines[k].s)) return k; }
    return -1;
  }
  function tick(){ return new Promise(r=>setTimeout(r, 0)); }

  // Hook up UI
  $('#runBtn').addEventListener('click', ()=> run($('#editor').value));
  $('#stopBtn').addEventListener('click', ()=> { halted = true; setStatus('Stopping‚Ä¶'); });
  document.addEventListener('keydown', (e)=>{
    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter'){ e.preventDefault(); $('#runBtn').click(); }
  });

  // Sample programs
  const samples = {
`Hello + INPUT demo`:
`DISPLAY("What is your name?")
SET name ‚Üê INPUT("name")
DISPLAY("Hello, " + name)
`,
`Math & IF`:
`SET a ‚Üê 5
SET b ‚Üê 12
SET s ‚Üê a + b
DISPLAY("sum = " + s)
IF s > 12
  DISPLAY("Big number")
ELSE
  DISPLAY("Small number")
END IF
`,
`REPEAT n TIMES`:
`REPEAT 5 TIMES
  DISPLAY("loop")
END REPEAT
`,
`RE
